name: Build LLMFarm for TrollStore

on:
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive # 必须递归下载子模块
          fetch-depth: 0

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install Dependencies (CMake & Ninja)
        run: |
          brew install cmake ninja

      - name: Build Llama Core (Fix Missing Binary)
        run: |
          # 这是一个关键步骤：编译 C++ 核心库
          # 1. 赋予脚本执行权限
          chmod +x build-xcframework_cpu.sh
          
          # 2. 运行编译脚本
          echo "Starting llama build script..."
          ./build-xcframework_cpu.sh
          
          # 3. 验证并修复路径 (如果脚本生成的路径和 Xcode 预期的不一致)
          # 错误日志提示 Xcode 在找: llmfarm_core.swift/llama.cpp/build-apple/llama.xcframework
          
          TARGET_DIR="llmfarm_core.swift/llama.cpp/build-apple"
          mkdir -p "$TARGET_DIR"
          
          # 检查根目录是否生成了 llama_cpu.xcframework 或者 llama.xcframework
          if [ -d "llama_cpu.xcframework" ]; then
            echo "Found llama_cpu.xcframework, copying to target..."
            cp -r llama_cpu.xcframework "$TARGET_DIR/llama.xcframework"
          elif [ -d "llama.xcframework" ]; then
             echo "Found llama.xcframework, copying to target..."
             cp -r llama.xcframework "$TARGET_DIR/llama.xcframework"
          else
             echo "Warning: Standard framework not found in root. Checking sub-directories..."
             # 尝试在常见的构建目录查找
             find . -name "llama.xcframework" -type d
          fi
          
          # 再次列出目标目录，确保文件存在
          ls -R "$TARGET_DIR"

      - name: Build Project (No Signing)
        run: |
          mkdir build
          
          xcodebuild build \
            -scheme LLMFarm \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -skipMacroValidation # 跳过宏验证，防止某些 Swift 宏报错

      - name: Package IPA
        run: |
          cd build/Build/Products/Release-iphoneos
          mkdir Payload
          cp -r LLMFarm.app Payload/
          zip -r LLMFarm_TrollStore.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: LLMFarm_IPA
          path: build/Build/Products/Release-iphoneos/LLMFarm_TrollStore.ipa
