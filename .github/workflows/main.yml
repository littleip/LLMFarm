name: Build LLMFarm Unsigned IPA

# 手动触发构建
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      # 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      # 安装CocoaPods依赖
      - name: Install CocoaPods and Dependencies
        run: |
          pod install --repo-update
          
      # 先创建导出用的plist文件（避开YAML语法冲突）
      - name: Create Export Options Plist
        run: |
          cat > ExportOptions.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>method</key>
  <string>development</string>
  <key>signingStyle</key>
  <string>manual</string>
  <key>stripSwiftSymbols</key>
  <false/>
  <key>teamID</key>
  <string>XXXX</string>
  <key>compileBitcode</key>
  <false/>
</dict>
</plist>
EOF
          
      # 编译并导出未签名IPA（使用独立的plist文件）
      - name: Build and Export Unsigned IPA
        run: |
          PROJECT_NAME="LLMFarm"
          SCHEME_NAME="LLMFarm"
          PROJECT_FILE="${PROJECT_NAME}.xcodeproj"
          
          # 清理缓存
          xcodebuild clean -project $PROJECT_FILE -scheme $SCHEME_NAME -configuration Release
          
          # 编译归档
          xcodebuild archive \
            -project $PROJECT_FILE \
            -scheme $SCHEME_NAME \
            -configuration Release \
            -archivePath ./build/LLMFarm.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
          
          # 导出IPA（使用提前创建的plist文件，核心修复点）
          xcodebuild -exportArchive \
            -archivePath ./build/LLMFarm.xcarchive \
            -exportPath ./build/IPA \
            -exportOptionsPlist ./ExportOptions.plist
          
      # 上传IPA供下载
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LLMFarm-Unsigned-IPA
          path: ./build/IPA/*.ipa
